/*!
 * jQuery Data Binder Plugin
 *
 * Provides easy data binding of a JSON object to an HTML template using jQuery.
 *
 * http://keithmcknight.net/
 * Copyright (c) 2012 Keith McKnight
 * Version: 0.3
 *
 * Dual licensed under the MIT and GPL licenses.
 */
 (function($){$.dataBind=function(){var plugin=this;plugin.set=function(selector,data){var element=$(selector);if(element.length>1)return element.each(function(i,o){plugin.set(o,data)});if(element.is(":input"))element.val(data).change();else if(element.is("img"))element.attr("src",data);else if(element.is("a"))element.attr("href",data);else element.html(data);element.attr("data-bindfield",true);return element};plugin.setData=function(selector,data,template){if($.isPlainObject(data))plugin.bind(selector,
data,template);else if($.isArray(data))plugin.bindArray(selector,data,template);else plugin.set(selector,data,template);return selector};plugin.bindArrayProto=function(selector,data,template){var element=$(selector);var prototype=element.filter(':first, [data-proto][data-proto!=""]').last();element.not(prototype).remove();var results=$();$.each(data,function(i,value){var field=prototype.clone().insertBefore(prototype);plugin.setData(field,value,template);results=results.add(field)});prototype.remove();
return results};plugin.bindArray=function(selector,data,template){var element=$(selector);var results=$();if(!element.length)return results;var keys=[];var parse=plugin.parseArrayName(element.attr("data-bindname"));element.filter('[data-bindname^="'+parse.name+'["]').each(function(i,o){var field=$(o);var parse=plugin.parseArrayName(field.attr("data-bindname"));if(parse.index<0)return;keys.push(parse.index);plugin.setData(field,data[parse.index],template);results.add(field)});var prototype=element.filter(':first, [data-proto][data-proto!=""]').last();
if(!keys.length)element.not(prototype).remove();$.each(data,function(i,value){if(keys.indexOf(i)>=0)return;var field=prototype.clone().insertBefore(prototype);plugin.setData(field,value,template);results=results.add(field)});if(!keys.length)prototype.remove();return results};plugin.bind=function(selector,data,template){if(typeof template==="string")return plugin.bindTemplate(selector,data,template);switch(typeof data){case "string":case "number":case "boolean":data=[data];default:break}if($.isArray(data))return plugin.bindArray(selector,
data,template);var elements=$(selector);elements.each(function(i,element){element=$(element);if(plugin.setSpecial&&plugin.setSpecial(element,data)){element.attr("data-bindexpand",true);return}$.each(data,function(key,value){var field=element.lazyFind('[data-bindname="'+key+'"] ');field=field.add('[data-bindname^="'+key+'["]');if(!field.length)if($.isPlainObject(template)&&template.hasOwnProperty(key)){field=$(template[key]).attr("data-bindname",key);element.append(field)}plugin.setData(field,value,
template)})});return elements};plugin.bindTemplate=function(target,data,template){if(typeof template==="undefined")return plugin.bind(target,data);return $(target).empty().append(plugin.bind(template,data))};plugin.dataLookup=function(data,path){if(typeof path==="string")path=path.replace(/\[([^\]]+)\]/g,".$1").replace(/['"]/,"").split(".");var search=data;$.each(path,function(i,p){return!!(search=search[p])});return search};plugin.extract=function(selector){var element=$(selector);if(element.is("[data-bindexpand]"))if(plugin.getSpecial&&
(specialData=plugin.getSpecial(element)))return specialData;if(element.attr("data-bindfield")||!element.children().length)if(element.is(":input"))return element.val();else if(element.is("img"))return element.attr("src");else if(element.is("a"))return element.attr("href");else return element.html();var data={};element.lazyFind('[data-bindname][data-bindname!=""]:not([data-bindnoextract])').each(function(i,o){o=$(o);var name=o.attr("data-bindname");var parse=plugin.parseArrayName(name);name=parse.name;
index=parse.index;if(name&&!data.hasOwnProperty(name))data[name]=plugin.extract(o);else if(name){if(!$.isArray(data[name]))data[name]=[data[name]];if(index<0)data[name].push(plugin.extract(o));else data[name][index]=plugin.extract(o)}});return data};plugin.parseArrayName=function(name){var index=-1;if(matches=name.match(/([^\[]+)\[\s*(\d+)\s*\]/)){name=matches[1];index=parseInt(matches[2])}return{name:name,index:index}};plugin.cleanObject=function(object,copy){if(!$.isPlainObject(object))return object;
if(copy)object=$.extend({},object);$.each(object,function(key,value){if(typeof value==="undefined")delete object[key]});return object};plugin.setSpecial=function(selector,data){if(!$.isPlainObject(data))return false;var element=$(selector);if(element.is(":input"))return!!plugin.setInput(element,data);if(element.is("img"))return!!plugin.setImage(element,data);if(element.is("a"))return!!plugin.setLink(element,data);return false};plugin.setInput=function(selector,data){var element=$(selector);if(typeof data.name!==
"undefined")element.attr("name",data.name);if(typeof data.title!=="undefined")element.attr("title",data.title);if(typeof data.placeholder!=="undefined")element.attr("placeholder",data.placeholder);if(typeof data.val!=="undefined")element.val(data.val);return element};plugin.setImage=function(selector,data){var element=$(selector);if(typeof data.url!=="undefined")element.attr("src",data.src);if(typeof data.src!=="undefined")element.attr("src",data.src);if(typeof data.lowsrc!=="undefined")element.attr("lowsrc",
data.lowsrc);if(typeof data.alt!=="undefined")element.attr("alt",data.alt);if(typeof data.title!=="undefined")element.attr("title",data.title);return element};plugin.setLink=function(selector,data){var element=$(selector);if(typeof data.url!=="undefined")element.attr("href",data.url);if(typeof data.href!=="undefined")element.attr("href",data.href);if(typeof data.target!=="undefined")element.attr("target",data.target);if(typeof data.name!=="undefined")element.attr("name",data.name);if(typeof data.title!==
"undefined")element.attr("title",data.title);if(typeof data.html!=="undefined")element.html(data.html);return element};plugin.getSpecial=function(selector){var element=$(selector);if(element.is(":input"))return plugin.getInput(element);if(element.is("img"))return plugin.getImage(element);if(element.is("a"))return plugin.getLink(element);return false};plugin.getInput=function(selector){var element=$(selector);return plugin.cleanObject({name:element.attr("name"),title:element.attr("title"),placeholder:element.attr("placeholder"),
val:element.val()})};plugin.getImage=function(selector){var element=$(selector);return plugin.cleanObject({url:element.attr("src"),src:element.attr("src"),lowsrc:element.attr("lowsrc"),alt:element.attr("alt"),title:element.attr("title")})};plugin.getLink=function(selector){var element=$(selector);return plugin.cleanObject({url:element.attr("href"),href:element.attr("href"),target:element.attr("target"),name:element.attr("name"),title:element.attr("title"),html:element.html()})};var command,selector,
data,template;switch(arguments.length){case 0:console.log("Try $.dataBind( selector, data, template )...");return;case 1:command=arguments[0];if($.isPlainObject(command)){selector=command.selector;data=command.data;command=command.command}else{selector=command;data={};command="extract"}break;case 2:selector=arguments[0];data=arguments[1];command="bind";if(!$.isPlainObject(data)&&!$.isArray(data)){command=data;data={}}break;case 3:selector=arguments[0];data=arguments[1];template=arguments[2];command=
"bind";if(!$.isPlainObject(data)&&!$.isArray(data)){command=data;data={}}break;default:selector=arguments[0];data=arguments[1];break}return plugin[command](selector,data,template)};$.fn.dataBind=function(data,template){switch(arguments.length){case 0:return $.dataBind(this);case 1:return $.dataBind(this,data);case 2:default:return $.dataBind(this,data,template)}};$.fn.lazyFind=function(s){var results=$();$(this).children().each(function(i,o){o=$(o);results=results.add(o.is(s)?o:o.lazyFind(s))});return results};
$.fn.lazyFind2=function(s){var start=$(this);var results=start.find(s);results.each(function(i,o){o=$(o);if(o.parent().closest(s,start).length)results=results.not(o)});return results};$.lazyFind=function(s){return $(document).lazyFind(s)};$.dataLookup=function(data,path){if(typeof path==="string")path=path.replace(/\[([^\]]+)\]/g,".$1").replace(/['"]/,"").split(".");var search=data;$.each(path,function(i,p){return!!(search=search[p])});return search};$.time=function(f,l){l=l||1;var s=(new Date).getTime();
for(var i=0;i<l;i++)f.call();var e=(new Date).getTime();var t=e-s;return l>1?[t/l,t,l]:t}})(jQuery);